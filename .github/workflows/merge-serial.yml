name: Merge Serial

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, ready_for_review]

concurrency:
  group: merge-serial
  cancel-in-progress: false

jobs:
  merge-serial:
    runs-on: ubuntu-latest
    timeout-minutes: 2
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify PR is based on latest main
        run: |
          git fetch origin main
          MAIN_SHA=$(git rev-parse origin/main)
          MERGE_BASE=$(git merge-base HEAD origin/main)

          if [ "$MAIN_SHA" = "$MERGE_BASE" ]; then
            echo "✅ PR is up-to-date with main ($MAIN_SHA)"
          else
            echo "❌ PR is NOT based on latest main"
            echo "   main HEAD:  $MAIN_SHA"
            echo "   merge-base: $MERGE_BASE"
            echo ""
            echo "Please rebase or merge main into your branch before merging."
            exit 1
          fi
