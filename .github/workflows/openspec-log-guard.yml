name: OpenSpec Log Guard

on:
  pull_request:
    branches: [main]

jobs:
  openspec-log-guard:
    runs-on: ubuntu-latest
    timeout-minutes: 2
    steps:
      - uses: actions/checkout@v4

      - name: Validate completed active changes are archived
        run: |
          python3 - <<'PY'
          import pathlib
          import re
          import sys

          root = pathlib.Path("openspec/changes")
          active = sorted(
            d for d in root.iterdir()
            if d.is_dir() and not d.name.startswith(".") and d.name not in {"archive", "_template"}
          )

          completed_active = []
          for change_dir in active:
            tasks_path = change_dir / "tasks.md"
            if not tasks_path.is_file():
              continue

            content = tasks_path.read_text(encoding="utf-8")
            marks = re.findall(r"^- \[([ xX])\]", content, flags=re.MULTILINE)
            if marks and all(mark.lower() == "x" for mark in marks):
              completed_active.append(change_dir.name)

          if completed_active:
            print(
              "❌ Completed changes must be archived to openspec/changes/archive/: "
              + ", ".join(completed_active)
            )
            sys.exit(1)

          print("✅ Completed active change archive guard passed")
          PY

      - name: Validate RUN_LOG or Skip-Reason
        env:
          PR_BODY: ${{ github.event.pull_request.body || '' }}
        run: |
          BRANCH="${{ github.head_ref }}"

          if [[ "$BRANCH" =~ ^task/([0-9]+)- ]]; then
            ISSUE_NUM="${BASH_REMATCH[1]}"
            RUN_LOG="openspec/_ops/task_runs/ISSUE-${ISSUE_NUM}.md"

            # Check file exists
            if [ ! -f "$RUN_LOG" ]; then
              echo "❌ RUN_LOG not found: $RUN_LOG"
              exit 1
            fi
            echo "✅ RUN_LOG found: $RUN_LOG"

            # Validate required fields
            MISSING=""
            grep -q "^- Issue:" "$RUN_LOG"   || MISSING="${MISSING} Issue"
            grep -q "^- Branch:" "$RUN_LOG"  || MISSING="${MISSING} Branch"
            grep -q "^- PR:" "$RUN_LOG"      || MISSING="${MISSING} PR"
            grep -q "^## Plan" "$RUN_LOG"    || MISSING="${MISSING} Plan"
            grep -q "^## Runs" "$RUN_LOG"    || MISSING="${MISSING} Runs"

            if [ -n "$MISSING" ]; then
              echo "❌ RUN_LOG missing required fields:${MISSING}"
              exit 1
            fi
            echo "✅ RUN_LOG format validated"

          else
            if printf '%s\n' "$PR_BODY" | grep -Eiq '^[[:space:]]*Skip-Reason[[:space:]]*:'; then
              echo "✅ Non-task branch with required Skip-Reason"
            else
              echo "❌ Non-task branch '$BRANCH' must include 'Skip-Reason:' in PR body"
              exit 1
            fi
          fi
