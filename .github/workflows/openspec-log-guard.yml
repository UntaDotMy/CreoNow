name: OpenSpec Log Guard

on:
  pull_request:
    branches: [main]

jobs:
  openspec-log-guard:
    runs-on: ubuntu-latest
    timeout-minutes: 2
    steps:
      - uses: actions/checkout@v4

      - name: Validate RUN_LOG or Skip-Reason
        env:
          PR_BODY: ${{ github.event.pull_request.body || '' }}
        run: |
          BRANCH="${{ github.head_ref }}"

          if [[ "$BRANCH" =~ ^task/([0-9]+)- ]]; then
            ISSUE_NUM="${BASH_REMATCH[1]}"
            RUN_LOG="openspec/_ops/task_runs/ISSUE-${ISSUE_NUM}.md"

            # Check file exists
            if [ ! -f "$RUN_LOG" ]; then
              echo "❌ RUN_LOG not found: $RUN_LOG"
              exit 1
            fi
            echo "✅ RUN_LOG found: $RUN_LOG"

            # Validate required fields
            MISSING=""
            grep -q "^- Issue:" "$RUN_LOG"   || MISSING="${MISSING} Issue"
            grep -q "^- Branch:" "$RUN_LOG"  || MISSING="${MISSING} Branch"
            grep -q "^- PR:" "$RUN_LOG"      || MISSING="${MISSING} PR"
            grep -q "^## Plan" "$RUN_LOG"    || MISSING="${MISSING} Plan"
            grep -q "^## Runs" "$RUN_LOG"    || MISSING="${MISSING} Runs"

            if [ -n "$MISSING" ]; then
              echo "❌ RUN_LOG missing required fields:${MISSING}"
              exit 1
            fi
            echo "✅ RUN_LOG format validated"

          else
            if printf '%s\n' "$PR_BODY" | grep -Eiq '^[[:space:]]*Skip-Reason[[:space:]]*:'; then
              echo "✅ Non-task branch with required Skip-Reason"
            else
              echo "❌ Non-task branch '$BRANCH' must include 'Skip-Reason:' in PR body"
              exit 1
            fi
          fi
