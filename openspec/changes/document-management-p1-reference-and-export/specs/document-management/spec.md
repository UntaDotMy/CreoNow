# Document Management Specification Delta

## Change: document-management-p1-reference-and-export

### Requirement: 文档间互相引用 [MODIFIED]

系统必须支持在正文中引用其他文档，并保证引用在目标文档删除后仍具备可解释的失效状态。

引用交互与契约约束：

- 用户输入 `[[` 时触发文档搜索面板，选择目标后插入引用节点（保存 `targetDocumentId` 与展示标题快照）。
- 引用节点默认可点击，点击后跳转并加载目标文档。
- 引用关系查询通过 `file:reference:list` 提供，以支撑失效引用检测与渲染。
- 当目标文档被删除，引用节点必须进入失效状态（删除线 + `--color-fg-disabled`），且不可点击。

#### Scenario: 用户通过 [[ 插入文档引用 [MODIFIED]

- **假设** 用户正在编辑文档正文
- **当** 用户输入 `[[` 并在搜索面板中选择目标文档
- **则** 系统在光标位置插入引用节点
- **并且** 节点保存目标文档 ID，并以高亮样式展示

#### Scenario: 用户点击引用节点跳转到目标文档 [MODIFIED]

- **假设** 当前文档中存在一个有效引用节点
- **当** 用户点击该引用节点
- **则** 系统加载并打开目标文档
- **并且** 编辑器焦点切换到目标文档内容区

#### Scenario: 被引用文档删除后的失效处理 [MODIFIED]

- **假设** 文档 A 中存在指向文档 B 的引用节点
- **当** 文档 B 被删除
- **则** 文档 A 中对应引用节点显示为失效状态（删除线 + 灰色文字）
- **并且** 点击失效节点不触发跳转
- **并且** Tooltip 明示「引用的文档已被删除」

### Requirement: 文档导出 [MODIFIED]

系统必须支持单文档与项目级导出，并确保导出路径、进度、错误码在用户界面可见。

导出契约与可见性约束：

- 单文档导出通过 `export:document`；项目导出通过 `export:project`。
- 两类导出都必须经过系统文件对话框选择保存路径后执行。
- 导出进行中必须显示进度（至少包含阶段文案与百分比）。
- 导出失败必须返回可判定错误结果：`{ ok: false, code, message }`。
- 导出失败时 UI 必须显示错误码与错误信息，并提供失败策略入口（`重试` 或 `更换路径`）。

推荐错误码基线（最少覆盖）：

| 错误码                    | 触发条件                    | UI 可见策略                           |
| ------------------------- | --------------------------- | ------------------------------------- |
| `EXPORT_DIALOG_CANCELLED` | 用户取消保存路径选择        | 显示非阻断提示，导出终止              |
| `EXPORT_WRITE_ERROR`      | 目标路径不可写              | 显示错误码 + message，允许重试/改路径 |
| `EXPORT_TRANSFORM_ERROR`  | 内容转换失败（md/pdf/docx） | 显示错误码 + message，允许重试        |

#### Scenario: 用户导出单文档并选择保存路径 [MODIFIED]

- **假设** 用户在文件树中选中文档「第一章」
- **当** 用户选择「导出 -> Markdown」并在文件对话框确认保存路径
- **则** 系统通过 `export:document` 在所选路径导出该文档
- **并且** 成功后反馈导出结果与目标文件名

#### Scenario: 用户导出整个项目并选择保存路径 [MODIFIED]

- **假设** 项目包含多个章节文档
- **当** 用户选择「导出项目 -> PDF」并在文件对话框确认保存路径
- **则** 系统通过 `export:project` 按章节顺序执行项目导出
- **并且** 成功后反馈项目导出完成

#### Scenario: 导出进度可见性 [MODIFIED]

- **假设** 用户触发一个耗时导出任务
- **当** 导出流程进入转换与写入阶段
- **则** UI 显示阶段文案（如「准备中/转换中/写入中」）与百分比进度
- **并且** 导出完成或失败后，进度状态及时结束并给出最终结果提示

#### Scenario: 导出失败时错误码与失败策略可见 [MODIFIED]

- **假设** 导出目标路径不可写
- **当** 系统返回 `{ ok: false, code: "EXPORT_WRITE_ERROR", message: "无法写入目标路径，请检查权限" }`
- **则** UI 明确显示错误码 `EXPORT_WRITE_ERROR` 与错误信息
- **并且** 用户可直接选择 `重试` 或 `更换路径` 继续处理失败任务
